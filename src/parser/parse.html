<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>


<script>
let count = 0

let source = `asdfsd<div id="123" {x} {...y} {x + y / 2} on:click={() => \`kdjk a}} s ${{x: 10}.x}dk\`}>askldfjalskjdflksd</div>`
let lastParser = parse


function dispatch(type, value) {
  console.log(lastParser)
  console.table({[type]: value})
}

const $skip = a => a

const $until = a => a

const $repeat = (...args) => () => {
  if (!source) return

  if (count++ > 100) {
    throw new Error("max circular")
  }

  const re = new RegExp("^(?:" + args.map(arg => arg[1].source).join("|") + ")")
  const m = re.exec(source)
  if (!m) {
    throw new Error("invalid. in " + lastParser.name)
  }

  source = RegExp.rightContext

  const index = m.slice(1).findIndex(arg => arg !== undefined)

  const target = args[index]
  const type = target[0]

  dispatch(type, m[0])

  let next = target[2]
  if (next === skip) {
    lastParser()
  } else if (next) {
    lastParser = next
    next()
  }
}


const ws = ["(ws)", /(\s+)/, skip]


/// root
const comment = ["(comment)", /(<!--)/, parse]

const elementOpen = ["(elementOpen)", /<([^\s\/>]+)/, attrs]

const elementClose = ["(elementClose)", /<\/([^>\s]+)[^>]*>/, parse]

const characters = ["(characters)", /([^<{]*)/, parse]


/// attr
const attrName = ["(attrName)", /([^\s=>]+)/, attr]

const attrEnd = ["(attrEnd)", /(>)/, parse]


const attrOperator = ["=", /([\s*]=[\s*])/, attrValue]

const interpolationStart = ["{", /(\{)/, interpolation]

const interpolationEnd = ["}", /(})/]


/// attrValue
const string1Start = ['"', /(")/, string1]

const string1Mid = ["(string1Mid)", /([^"]+)/, string1]

const string1End = ["(string1End)", /(")/]


const string2Start = ["'", /(')/]


function parse() {
  $repeat(comment, elementOpen, elementClose, characters, interpolationStart)()
}

function attrs() {
  $repeat($skip(ws), attrName, interpolationStart, $until(attrEnd))
}

function attr() {
  $repeat(attrOperator, $until(ws))
}

function attrValue() {
  $repeat(string1Start, string2Start, interpolationStart, $until(ws, attrEnd))()
}

function string1() {
  $repeat(string1Mid, string1End)()
}

function interpolation() {
  $repeat(ws, string1Start, string2Start, interpolationStart)()
}


parse(source)


</script>
</body>
</html>