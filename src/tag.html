<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>


<script>
const startTagRe = /^<([^>\s\/]+)((\s+[^=>\s]+(\s*=\s*((\"[^"]*\")|(\'[^']*\')|[^>\s]+))?)*)\s*\/?\s*>/m
const endTagRe = /^<\/([^>\s]+)[^>]*>/m


const attrRe = /([^=\s]+)(\s*=\s*((\"([^"]*)\")|(\'([^']*)\')|[^>\s]+))?/gm


function parse(source, contentHandler) {

  let lm, rc, index
  let treatAsChars = false

  while (source.length > 0) {

    // Comment
    if (source.startsWith("<!--")) {
      index = source.indexOf("-->")
      if (index !== -1) {
        contentHandler.comment(source.substring(4, index))
        source = source.substring(index + 3)
        treatAsChars = false
      } else {
        treatAsChars = true
      }
    }

    // end tag
    else if (source.startsWith("</")) {
      if (endTagRe.test(source)) {
        lm = RegExp.lastMatch
        rc = RegExp.rightContext

        lm.replace(endTagRe, (_, sTagName) => contentHandler.endElement(sTagName))

        source = rc
        treatAsChars = false
      } else {
        treatAsChars = true
      }
    }

    // start tag
    else if (source.startsWith("<")) {
      if (startTagRe.test(source)) {
        lm = RegExp.lastMatch
        rc = RegExp.rightContext

        lm.replace(startTagRe, (_, sTagName, sRest) => contentHandler.startElement(sTagName, parseAttributes(sTagName, sRest)))

        source = rc
        treatAsChars = false
      } else {
        treatAsChars = true
      }
    }

    if (treatAsChars) {
      index = source.indexOf("<")
      if (index === -1) {
        contentHandler.characters(source)
        source = ""
      } else {
        contentHandler.characters(source.substring(0, index))
        source = source.substring(index)
      }
    }

    treatAsChars = true
  }
}


/* state,

 [operator]() {

    if (!regxp.test(source)) {
      return nextState
    }

    RegExp.lastMath.replace(regexp, () => dispatch(....)))
    RegExp.rightContext

    return nextState
 }

*/


function parseAttributes(sTagName, s) {
  let attrs = []
  s.replace(attrRe, (...args) => attrs.push(parseAttribute(sTagName, ...args)))
  return attrs
}

function parseAttribute(sTagName, sAttribute, sName) {
  let value = ""
  if (arguments[7])
    value = arguments[8]
  else if (arguments[5])
    value = arguments[6]
  else if (arguments[3])
    value = arguments[4]

  let empty = !value && !arguments[3]
  return {name: sName, value: empty ? null : value}
}
</script>


<script>


fetch("App.svelte").then(res => res.text()).then(code => {

  console.log(code)

  parse(code, {
    comment() {
      console.log("comment", arguments)
    },

    startElement(tagName, attrs) {
      console.log("startElement", tagName)

      for (const attr of attrs) {
        console.log("attribute", attr)
      }
    },

    endElement() {
      console.log("endElement", arguments)
    },

    characters() {
      console.log("characters", arguments)
    }
  })


})


</script>

</body>
</html>