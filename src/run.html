<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>


<main id="m"></main>


<script>
let dirty
let bindings = []

const noop = () => {}

const invalidate = (value, flag) => {
  dirty |= (dirty || requestAnimationFrame(updates) && flag)

  console.log('invalidate', value, flag)
  console.log('bindings', bindings)

  return value
}

/// @TODO: 너무 꺼내고 하는게 많은데? 잘 정리 좀 해보자.
const updates = () => {
  console.log('updates dirty', dirty)
  for (const binding of bindings) update(binding, dirty)
  dirty = 0
}

const update = (binding, dirty) => {
  let [value, updateCallback, dataCallback, ...keys] = binding
  for (const key of keys) {
    if (key & dirty) return (value !== (binding[0] = value = dataCallback()) && updateCallback(value))
  }
}


const render = (createInstance, ...nodes) => (target) => {
  const ctx = createInstance(invalidate)
  for (const node of nodes) node(target, ctx)
}

const element = (tagName, ...nodes) => (target, ctx) => {
  const el = document.createElement(tagName)
  for (const node of nodes) node(el, ctx)
  target.appendChild(el)
  return () => [
    () => {},
    () => {}
  ]
}

const attr = (nodeName, nodeValue = '') => (el) => {
  el.setAttribute(nodeName, nodeValue)
  return [
    (nodeValue) => el.setAttribute(nodeName, nodeValue),
    () => {}
  ]
}

const text = (data = '') => (el) => {
  const textNode = document.createTextNode(data)
  el.appendChild(textNode)
  return [
    (data) => textNode.nodeValue = data
  ]
}

const bind = (callback, index, mask) => (el, ctx) => {
  const [updateCallback] = callback(el, ctx)
  const binding = [undefined, updateCallback, ctx[index], mask]
  bindings.push(binding)
  update(binding, mask)
}
</script>


<script>
function createInstance(invalidate) {
  let name = 100
  let count = 0
  let x = 0,
    y = 0

  name = 0
  name += 5

  // [name] = [100, 200]

  setInterval(() => {
    invalidate(name++, 1)
  }, 1000)

  const inc = () => invalidate(count++, 2)
  const inc2 = () => invalidate(count += 5, 2)
  return [() => name, () => name, () => name, () => count, () => x + y, () => event => inc(event)]
}

const r = render(createInstance,
  element('div', bind(attr('class'), 0, 1),
    element('h1', text('hello, '), bind(text(), 1, 1), text('!')),
    element('h1', text('hello2, '), bind(text(), 2, 1), text('?')),
    element('h2', text('count: '), bind(text(), 3, 2)),
    element('h3', text('sum: '), bind(text(), 4, 12)),
    element('button', bind(attr('on:click'), 5, 16), text('inc'))))


r(document.getElementById("m"))

setTimeout(() => {
  console.log(document.getElementById("m").innerHTML)
})


</script>
</body>
</html>