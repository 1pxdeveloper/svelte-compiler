<script>
const createEscapeOneLineRegexp = (open, close = open, ...blocks) => new RegExp(`${open}(?:${blocks.map(b => b + '|').join('')}\\\\.|[^\\\\${close}\n])*${close}`)
const string1 = createEscapeOneLineRegexp('"')
const string2 = createEscapeOneLineRegexp("'")
const template = createEscapeOneLineRegexp("`")
const templateStart = createEscapeOneLineRegexp("`", "\\$\\{")
const templateMid = createEscapeOneLineRegexp("}", "\\$\\{")
const templateEnd = createEscapeOneLineRegexp("}", "`")

const regexp_bracket = createEscapeOneLineRegexp("\\[", "\\]")
const regexp = createEscapeOneLineRegexp("\\/", "\\/", regexp_bracket.source)

const operator = /[{}]/
const content = /[^'"`{}\s]+/

const lex = [
  ["(string)", string1],
  ["(string)", string2],
  ["(template)", template],
  ["(regexp)", regexp],
  ["(operator)", operator],
  ["(content)", content],
  ["(ws)", /\s+/],
  ["(unknown)", /./],
]

const re = new RegExp(lex.map(([type, regexp]) => "(" + regexp.source + ")").join("|"), "gu")


const script = "{  x + {x:`}}`}.x } asdlkfj askld f {x} {y}"


function brace(count = 0) {
  let result = ""
  let m

  while (m = re.exec(script)) {
    let value = m.shift()
    let index = m.findIndex(a => a)
    let type = lex[index][0]

    result += value

    console.log(count, type, value, result)

    if (value === "{") {
      console.log("in-----")
      result += brace(count + 1)
      if (count === 0) return result
    }

    else if (value === "}") {
      return result
    }
  }

  throw new Error("????????????????????????")
}


const v = brace()


console.log("vvvvv", v)


</script>